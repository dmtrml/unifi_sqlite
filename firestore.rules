/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user can only
 * access data directly associated with their own user ID. This ensures
 * privacy and prevents unauthorized data access.
 *
 * Data Structure:
 * The database is structured with user-specific collections nested under
 * the `/users/{userId}` path. This segregation ensures that data is
 * isolated and access can be controlled at the user level.
 *
 * Key Security Decisions:
 * - Users can only create, read, update, and delete their own data.
 * - Listing of user documents is disallowed for privacy.
 * - The rules are designed to be data-shape agnostic to allow rapid
 *   iteration during the prototyping phase. Data validation is limited
 *   to ensuring data consistency for authorization purposes (e.g.,
 *   matching user IDs in paths and document fields).
 *
 * Denormalization for Authorization:
 * All documents under a user's path contain the `userId` field. This
 * denormalization allows for efficient security checks without needing
 * additional reads. For example, when securing `/users/{userId}/transactions/{transactionId}`,
 * the `Transaction` document itself should contain a `userId` field
 * that matches the `{userId}` in the path. This allows us to easily
 * validate ownership with `isOwner(userId)`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects the `/users` collection. Only allows a user to read and write their own document.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user_abc' can create /users/user_abc if they are authenticated.
     * @allow (get, update, delete) - User with UID 'user_abc' can read, update, and delete /users/user_abc if they are authenticated.
     * @deny (create, get, update, delete) - User with UID 'user_xyz' cannot access /users/user_abc.
     * @deny (list) - Nobody can list the /users collection.
     * @principle Enforces strict user ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects the `/users/{userId}/transactions` collection. Only the owner can create, read, update, and delete transactions.
     * @path /users/{userId}/transactions/{transactionId}
     * @allow (create) - User with UID 'user_abc' can create /users/user_abc/transactions/transaction_123 if authenticated. The transaction document must contain userId: 'user_abc'.
     * @allow (get, update, delete) - User with UID 'user_abc' can read, update, and delete /users/user_abc/transactions/transaction_123 if authenticated.
     * @deny (create, get, update, delete) - User with UID 'user_xyz' cannot access /users/user_abc/transactions/transaction_123.
     * @principle Enforces document ownership and prevents cross-user data access.
     */
    match /users/{userId}/transactions/{transactionId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(userId) {
          return request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects the `/users/{userId}/categories` collection. Only the owner can create, read, update, and delete categories.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) - User with UID 'user_abc' can create /users/user_abc/categories/category_123 if authenticated. The category document must contain userId: 'user_abc'.
     * @allow (get, update, delete) - User with UID 'user_abc' can read, update, and delete /users/user_abc/categories/category_123 if authenticated.
     * @deny (create, get, update, delete) - User with UID 'user_xyz' cannot access /users/user_abc/categories/category_123.
     * @principle Enforces document ownership and prevents cross-user data access.
     */
    match /users/{userId}/categories/{categoryId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(userId) {
          return request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects the `/users/{userId}/budgets` collection. Only the owner can create, read, update, and delete budgets.
     * @path /users/{userId}/budgets/{budgetId}
     * @allow (create) - User with UID 'user_abc' can create /users/user_abc/budgets/budget_123 if authenticated. The budget document must contain userId: 'user_abc'.
     * @allow (get, update, delete) - User with UID 'user_abc' can read, update, and delete /users/user_abc/budgets/budget_123 if authenticated.
     * @deny (create, get, update, delete) - User with UID 'user_xyz' cannot access /users/user_abc/budgets/budget_123.
     * @principle Enforces document ownership and prevents cross-user data access.
     */
    match /users/{userId}/budgets/{budgetId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(userId) {
          return request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects the `/users/{userId}/recurringTransactions` collection. Only the owner can create, read, update, and delete recurring transactions.
     * @path /users/{userId}/recurringTransactions/{recurringTransactionId}
     * @allow (create) - User with UID 'user_abc' can create /users/user_abc/recurringTransactions/recurringTransaction_123 if authenticated. The recurringTransaction document must contain userId: 'user_abc'.
     * @allow (get, update, delete) - User with UID 'user_abc' can read, update, and delete /users/user_abc/recurringTransactions/recurringTransaction_123 if authenticated.
     * @deny (create, get, update, delete) - User with UID 'user_xyz' cannot access /users/user_abc/recurringTransactions/recurringTransaction_123.
     * @principle Enforces document ownership and prevents cross-user data access.
     */
    match /users/{userId}/recurringTransactions/{recurringTransactionId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(userId) {
          return request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects the `/users/{userId}/accounts` collection. Only the owner can create, read, update, and delete accounts.
     * @path /users/{userId}/accounts/{accountId}
     * @allow (create) - User with UID 'user_abc' can create /users/user_abc/accounts/account_123 if authenticated. The account document must contain userId: 'user_abc'.
     * @allow (get, update, delete) - User with UID 'user_abc' can read, update, and delete /users/user_abc/accounts/account_123 if authenticated.
     * @deny (create, get, update, delete) - User with UID 'user_xyz' cannot access /users/user_abc/accounts/account_123.
     * @principle Enforces document ownership and prevents cross-user data access.
     */
    match /users/{userId}/accounts/{accountId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(userId) {
          return request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
        allow delete: if isExistingOwner(userId);
    }
  }
}